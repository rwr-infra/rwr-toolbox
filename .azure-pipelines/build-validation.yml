# Azure Pipelines Build Validation
# Validates that the application builds successfully on all platforms
# Triggers on pushes to master branch and pull requests targeting master

trigger:
    branches:
        include:
            - master

pr:
    branches:
        include:
            - master

jobs:
    - job: build_validation
      displayName: Build Validation (Matrix)
      strategy:
          matrix:
              macos:
                  vmImage: 'macos-latest'
                  TAURI_ARGS: '--target universal-apple-darwin'
              linux:
                  vmImage: 'ubuntu-22.04'
                  TAURI_ARGS: ''
              windows:
                  vmImage: 'windows-latest'
                  TAURI_ARGS: ''

      pool:
          vmImage: $(vmImage)

      steps:
          - checkout: self

          # Setup Node.js
          - task: UseNode@1
            displayName: 'Setup Node.js LTS'
            inputs:
                version: '20.x'

          # Enable pnpm
          - script: corepack enable
            displayName: 'Enable pnpm'

          # Install Rust stable
          - script: |
                rustup toolchain install stable
                rustup default stable
            displayName: 'Install Rust stable'

          # Add macOS targets for universal binary
          - script: |
                rustup target add aarch64-apple-darwin x86_64-apple-darwin
            displayName: 'Add macOS targets'
            condition: eq(variables['Agent.OS'], 'Darwin')

          # Install Linux dependencies for Tauri (WebView)
          - script: |
                sudo apt-get update
                sudo apt-get install -y \
                  libwebkit2gtk-4.1-dev \
                  libappindicator3-dev \
                  librsvg2-dev \
                  patchelf
            displayName: 'Install Linux dependencies'
            condition: eq(variables['Agent.OS'], 'Linux')

          # Install frontend dependencies
          - script: pnpm install
            displayName: 'Install frontend dependencies'

          # Build Tauri app in debug mode (validation only)
          - script: pnpm run tauri build --debug $(TAURI_ARGS)
            displayName: 'Build Tauri app (debug)'
