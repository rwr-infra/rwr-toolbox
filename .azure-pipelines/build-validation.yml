trigger:
  branches:
    include: [ master ]
pr:
  branches:
    include: [ master ]

jobs:
  - job: build_validation
    displayName: Build Validation
    strategy:
      matrix:
        macos:
          vmImage: 'macos-latest'
          TAURI_ARGS: '--target universal-apple-darwin'
        linux:
          vmImage: 'ubuntu-22.04'
          TAURI_ARGS: ''
        windows:
          vmImage: 'windows-latest'
          TAURI_ARGS: ''

    pool:
      vmImage: $(vmImage)

    steps:
      - checkout: self

      # 修复点：使用 $env:HOME 处理跨平台用户目录路径
      - pwsh: |
          $pnpmStore = "$(Pipeline.Workspace)/.pnpm-store"
          if (!(Test-Path $pnpmStore)) { New-Item -ItemType Directory -Force -Path $pnpmStore }
          
          # 在 Windows 上 HOME 可能未定义，需兼容 USERPROFILE
          $homePath = if ($env:HOME) { $env:HOME } else { $env:USERPROFILE }
          $cargoReg = Join-Path $homePath ".cargo"
          
          if (!(Test-Path $cargoReg)) { New-Item -ItemType Directory -Force -Path $cargoReg }
          
          # 将处理好的路径存入变量，方便后续 Cache 任务调用
          Write-Host "##vso[task.setvariable variable=CARGO_HOME]$cargoReg"
        displayName: 'Pre-create Cache Directories'

      - task: Cache@2
        inputs:
          key: 'pnpm | "$(Agent.OS)" | **/pnpm-lock.yaml'
          path: $(Pipeline.Workspace)/.pnpm-store
        displayName: 'Cache pnpm'

      - task: Cache@2
        inputs:
          key: 'cargo-reg | "$(Agent.OS)" | src-tauri/Cargo.lock'
          path: $(CARGO_HOME)
        displayName: 'Cache Cargo Registry'

      - task: Cache@2
        inputs:
          key: 'cargo-target-debug | "$(Agent.OS)" | src-tauri/Cargo.lock'
          path: src-tauri/target
        displayName: 'Cache Rust Debug Target'

      - task: UseNode@1
        inputs: { version: '20.x' }

      - script: |
          corepack enable
          pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
          pnpm install
        displayName: 'Install Frontend Deps'

      - script: |
          rustup toolchain install stable --profile minimal
          rustup default stable
        displayName: 'Install Rust (Minimal)'

      - script: rustup target add aarch64-apple-darwin x86_64-apple-darwin
        displayName: 'Add macOS targets'
        condition: eq(variables['Agent.OS'], 'Darwin')

      - script: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        displayName: 'Install Linux Deps'
        condition: eq(variables['Agent.OS'], 'Linux')

      - script: pnpm tauri build --debug $(TAURI_ARGS)
        displayName: 'Tauri Build (Debug Validation)'