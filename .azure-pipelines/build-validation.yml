trigger:
  branches:
    include: [ master ]
pr:
  branches:
    include: [ master ]

jobs:
  - job: build_validation
    strategy:
      matrix:
        macos:
          vmImage: 'macos-latest'
          TAURI_ARGS: '--target universal-apple-darwin'
        linux:
          vmImage: 'ubuntu-22.04'
          TAURI_ARGS: ''
        windows:
          vmImage: 'windows-latest'
          TAURI_ARGS: ''

    pool:
      vmImage: $(vmImage)

    variables:
      # 参考 pnpm 官方 CI 文档：定义 pnpm 全局目录
      PNPM_CACHE_FOLDER: $(Pipeline.Workspace)/pnpm_cache

    steps:
      - checkout: self

      # 1. 跨平台创建目录（使用原生 PowerShell 语法）
      - pwsh: |
          New-Item -ItemType Directory -Force -Path "$(PNPM_CACHE_FOLDER)"
          $homePath = if ($env:HOME) { $env:HOME } else { $env:USERPROFILE }
          $cargoReg = Join-Path $homePath ".cargo"
          if (!(Test-Path $cargoReg)) { New-Item -ItemType Directory -Force -Path $cargoReg }
          Write-Host "##vso[task.setvariable variable=CARGO_HOME]$cargoReg"
        displayName: 'Pre-create Cache Directories'

      # 2. 缓存配置 (参考 Azure 官方 Cache@2 最佳实践)
      - task: Cache@2
        inputs:
          key: 'pnpm | "$(Agent.OS)" | **/pnpm-lock.yaml'
          path: $(PNPM_CACHE_FOLDER)
        displayName: 'Cache pnpm'

      - task: Cache@2
        inputs:
          key: 'cargo-reg | "$(Agent.OS)" | src-tauri/Cargo.lock'
          path: $(CARGO_HOME)
        displayName: 'Cache Cargo'

      # Cache Rust build outputs (similar to what GitHub Actions often achieves via action-level caching).
      # This is typically the biggest win for Windows builds.
      - task: Cache@2
        inputs:
          key: 'cargo-target | "$(Agent.OS)" | src-tauri/Cargo.lock'
          restoreKeys: |
            cargo-target | "$(Agent.OS)"
          path: $(Build.SourcesDirectory)/src-tauri/target
        displayName: 'Cache Cargo target/'

      - task: UseNode@1
        inputs:
          version: '24.x'

      # 3. 依赖安装（包含 tauri CLI）
      - pwsh: |
          $ErrorActionPreference = 'Stop'
          corepack enable
          corepack prepare pnpm@10.28.1 --activate
          pnpm config set store-dir "$(PNPM_CACHE_FOLDER)"
          pnpm config set prefer-offline true
          # Warm the pnpm store from the lockfile, then install.
          pnpm fetch --frozen-lockfile
          pnpm install --frozen-lockfile --offline
          if ($LASTEXITCODE -ne 0) {
            # First run (cold cache) may not have everything in the store yet.
            pnpm install --frozen-lockfile
          }
          pnpm exec tauri --version
        displayName: 'Install Dependencies'
        workingDirectory: $(Build.SourcesDirectory)
        env:
          # pnpm/tauri cli uses platform-specific optionalDependencies (e.g. @tauri-apps/cli-win32-x64-msvc).
          # Some CI environments set npm_config_optional=false; force it on explicitly.
          npm_config_optional: 'true'
          npm_config_no_optional: 'false'
          # Ensure devDependencies are installed (where @tauri-apps/cli lives).
          npm_config_production: 'false'
          NODE_ENV: 'development'

      - script: |
          rustup default stable
        displayName: 'Setup Rust'

      - script: rustup target add aarch64-apple-darwin x86_64-apple-darwin
        displayName: 'Add macOS targets'
        condition: eq(variables['Agent.OS'], 'Darwin')

      - script: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        displayName: 'Install Linux Deps'
        condition: eq(variables['Agent.OS'], 'Linux')

      # 4. 执行构建（通过 pnpm exec 确保正确解析 tauri CLI）
      # Build validation should compile fast; skip bundling/packaging.
      - script: pnpm exec tauri build --debug --no-bundle $(TAURI_ARGS)
        displayName: 'Tauri Build'
        workingDirectory: $(Build.SourcesDirectory)
        env:
          npm_config_optional: 'true'
          npm_config_no_optional: 'false'
          npm_config_production: 'false'
          NODE_ENV: 'development'
