trigger:
    tags:
        include:
            - '*'

jobs:
    - job: publish_tauri
      displayName: Publish Tauri Release (Matrix)
      strategy:
          matrix:
              macos:
                  vmImage: 'macos-latest'
                  TAURI_ARGS: '--target universal-apple-darwin'
                  OS_NAME: 'macos'
              linux:
                  vmImage: 'ubuntu-22.04'
                  TAURI_ARGS: ''
                  OS_NAME: 'linux'
              windows:
                  vmImage: 'windows-latest'
                  TAURI_ARGS: '--bundles nsis'
                  OS_NAME: 'windows'

      pool:
          vmImage: $(vmImage)

      continueOnError: true

      steps:
          - checkout: self

          # Node.js
          - task: UseNode@1
            displayName: Setup Node.js
            inputs:
                version: '20.x'

          - script: corepack enable
            displayName: Enable pnpm

          # Rust
          - script: |
                rustup toolchain install stable
                rustup default stable
            displayName: Install Rust stable

          - script: |
                rustup target add aarch64-apple-darwin x86_64-apple-darwin
            displayName: Add macOS targets
            condition: eq(variables['vmImage'], 'macos-latest')

          # Linux deps
          - script: |
                sudo apt-get update
                sudo apt-get install -y \
                  libwebkit2gtk-4.1-dev \
                  libappindicator3-dev \
                  librsvg2-dev \
                  patchelf
            displayName: Install Linux dependencies
            condition: eq(variables['vmImage'], 'ubuntu-22.04')

          # Frontend deps
          - script: pnpm install
            displayName: Install frontend dependencies

          # Build Tauri (release)
          - script: pnpm run tauri build $(TAURI_ARGS)
            displayName: Build Tauri app (release)

          # Collect artifacts
          - task: PublishBuildArtifacts@1
            displayName: Publish build artifacts
            inputs:
                pathToPublish: src-tauri/target/release
                artifactName: tauri-$(OS_NAME)
