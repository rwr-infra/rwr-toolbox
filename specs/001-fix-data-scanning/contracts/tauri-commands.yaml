# Tauri Command Contracts
# Feature: 001-fix-data-scanning

# This file defines the Tauri command contracts between frontend and backend.
# Modifications are marked with "MODIFIED" comments.

commands:
  # ========================================================================
  # VALIDATION COMMANDS
  # ========================================================================

  validate_game_path:
    description: Validate a game directory path and count packages
    inputs:
      game_path: string
    outputs:
      valid: boolean
      weapons_path: string
      package_count: number        # MODIFIED: Now returns package count
      error_code?: string          # MODIFIED: Added for better error handling
      message?: string             # MODIFIED: Added for better error handling
    mod: modified

  # ========================================================================
  # WEAPON SCANNING COMMANDS
  # ========================================================================

  scan_weapons:
    description: Scan all weapon files from game directory using parallel processing
    inputs:
      game_path: string
      directory?: string           # If provided, scan this specific packages directory
    outputs:
      weapons: Weapon[]
      errors: ScanError[]
      duplicate_keys: string[]
      scan_time: number            # milliseconds
    mod: modified                 # MODIFIED: Now uses rayon parallel processing

  get_texture_path:
    description: Get the absolute path to a weapon icon file
    inputs:
      weapon_file_path: string
      icon_filename: string
    outputs:
      path: string                 # Absolute path to icon file
    mod: unchanged

  get_weapon_icon_base64:
    description: Get weapon icon as base64 data URL (fallback for asset:// protocol issues)
    inputs:
      weapon_file_path: string
      icon_filename: string
    outputs:
      data_url: string             # data:image/png;base64,...
    mod: unchanged

  open_file_in_editor:
    description: Open a file in the system's default text editor
    inputs:
      file_path: string
    outputs: null
    mod: unchanged

  # ========================================================================
  # ITEM SCANNING COMMANDS
  # ========================================================================

  scan_items:
    description: Scan all item files from game directory using parallel processing
    inputs:
      game_path: string
      directory?: string           # If provided, scan this specific packages directory
    outputs:
      items: Item[]
      errors: ScanError[]
      duplicate_keys: string[]
      scan_time: number            # milliseconds
    mod: modified                 # MODIFIED: Now uses rayon parallel processing

  get_item_texture_path:
    description: Get the absolute path to an item icon file
    inputs:
      item_file_path: string
      icon_filename: string
    outputs:
      path: string                 # Absolute path to icon file
    mod: unchanged

  get_item_icon_base64:
    description: Get item icon as base64 data URL
    inputs:
      item_file_path: string
      icon_filename: string
    outputs:
      data_url: string             # data:image/png;base64,...
    mod: unchanged

# ========================================================================
# TYPE DEFINITIONS
# ========================================================================

types:
  # Error reported during scanning
  ScanError:
    file: string                   # Path to file that failed to parse
    error: string                  # Error message
    severity: string               # "error" | "warning"

  # Weapon entity
  Weapon:
    key?: string
    name: string
    tag: string                    # Weapon type (assault, smg, etc.)
    class: number                  # Numeric class value
    magazine_size: number
    kill_probability: number
    retrigger_time: number
    burst_shots?: number
    spread_range?: number
    sight_range_modifier?: number
    projectile_speed?: number
    barrel_offset?: number
    encumbrance?: number
    price?: number
    suppressed: boolean
    can_respawn_with: boolean
    in_stock: boolean
    chain_variants: string[]       # List of weapon keys in chain
    stance_accuracies: StanceAccuracy[]
    file_path: string              # Relative path from packages root
    source_file: string            # Absolute path on filesystem
    package_name: string           # Package subdirectory name
    hud_icon?: string              # Icon filename

  # Stance accuracy value
  StanceAccuracy:
    stance: string                 # running, crouching, proning, etc.
    accuracy: number               # 0.0 to 1.0

  # Item entity (unified for carry_item and visual_item)
  Item:
    key?: string
    name: string
    item_type: string              # "carry_item" | "visual_item"
    encumbrance?: number
    price?: number
    can_respawn_with?: boolean
    in_stock?: boolean
    file_path: string              # Relative path from packages root
    source_file: string            # Absolute path on filesystem
    package_name: string           # Package subdirectory name
    slot?: string                  # Inventory slot
    transform_on_consume?: string
    time_to_live?: number
    draggable?: boolean
    modifiers?: ItemModifier[]
    hud_icon?: string              # Icon filename
    model_filename?: string
    mesh_filenames?: string[]
    effect_ref?: string
    capacity?: ItemCapacity
    commonness?: ItemCommonness

  # Item modifier
  ItemModifier:
    modifier_class: string         # "class" of the modifier
    value?: number
    input_character_state?: string
    output_character_state?: string
    consumes_item?: boolean

  # Item capacity/spawn requirements
  ItemCapacity:
    value?: number
    source?: string
    source_value?: number

  # Item spawn frequency settings
  ItemCommonness:
    value?: number
    in_stock?: boolean
    can_respawn_with?: boolean

# ========================================================================
# MODIFICATION NOTES
# ========================================================================

modification_notes: |
  KEY CHANGES IN THIS FEATURE:

  1. validate_game_path:
     - Added package_count output (number of package subdirectories)
     - Added error_code and message for better i18n

  2. scan_weapons / scan_items:
     - Now uses rayon for parallel file processing
     - Internal implementation change, contract unchanged
     - Performance: 3-7x faster depending on CPU cores

  3. Template resolution:
     - Internal change to resolve_template() function
     - Now resolves relative to file location, not packages root
     - No contract change (internal implementation)

  4. New state fields (frontend-only, not in contracts):
     - ScanDirectory.active (boolean)
     - ScanDirectory.packageCount (number)
     - ValidationResult.packageCount (number)
