<div class="p-6 max-w-5xl mx-auto" *transloco="let t">
    <h1 class="text-2xl font-bold mb-6">{{ t('menu.settings') }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Language Settings -->
        <div class="card bg-base-100 shadow-sm border border-base-300/50">
            <div class="card-body">
                <h2 class="card-title text-sm uppercase opacity-50 mb-2">
                    {{ t('settings.language') }}
                </h2>
                <div class="form-control">
                    <select
                        class="select select-bordered select-sm"
                        [value]="localeValue"
                        (change)="onLocaleChange($event)"
                    >
                        @for (locale of locales; track locale.value) {
                            <option
                                [value]="locale.value"
                                [selected]="localeValue === locale.value"
                            >
                                {{ locale.label }}
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>

        <!-- Theme Settings -->
        <div class="card bg-base-100 shadow-sm border border-base-300/50">
            <div class="card-body">
                <h2 class="card-title text-sm uppercase opacity-50 mb-2">
                    {{ t('settings.theme') }}
                </h2>
                <div class="form-control">
                    <select
                        class="select select-bordered select-sm"
                        (change)="onThemeChange($event)"
                    >
                        <option
                            value="auto"
                            [selected]="currentTheme === 'auto'"
                        >
                            {{ t('settings.themeAuto') }}
                        </option>
                        <option
                            value="light"
                            [selected]="currentTheme === 'light'"
                        >
                            {{ t('settings.themeLight') }}
                        </option>
                        <option
                            value="dark"
                            [selected]="currentTheme === 'dark'"
                        >
                            {{ t('settings.themeDark') }}
                        </option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Management (Full Width) -->
    <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div class="card-body">
            <!-- Game install directory -->
            <div class="flex justify-between items-start gap-4">
                <div class="min-w-0">
                    <h2 class="card-title text-sm uppercase opacity-50">
                        {{ t('settings.gamePath') }}
                    </h2>
                    <p class="text-[11px] opacity-60 mt-1">
                        {{ t('settings.gamePathHint') }}
                    </p>
                </div>

                <div class="flex items-center gap-2">
                    <button
                        class="btn btn-primary btn-sm"
                        (click)="onSelectGameInstallDirectory()"
                    >
                        <i-lucide name="folder-open" class="h-4 w-4"></i-lucide>
                        {{ t('settings.selectGameInstallDirectory') }}
                    </button>
                    <button
                        class="btn btn-ghost btn-sm transition-all duration-150 ease"
                        (click)="onClearGameInstallDirectory()"
                        [disabled]="!gameInstallDirectorySig()"
                    >
                        <i-lucide name="trash-2" class="h-4 w-4"></i-lucide>
                        {{ t('settings.clearGameInstallDirectory') }}
                    </button>
                    <button
                        class="btn btn-outline btn-sm"
                        (click)="onValidateGameInstallDirectory()"
                        [disabled]="validatingGameInstallDirSig()"
                    >
                        @if (validatingGameInstallDirSig()) {
                            <span
                                class="loading loading-spinner loading-xs"
                            ></span>
                        }
                        <i-lucide name="refresh-cw" class="h-4 w-4"></i-lucide>
                        {{ t('settings.validatePath') }}
                    </button>
                </div>
            </div>

            <div
                class="mt-3 p-3 bg-base-200/40 rounded-lg border border-base-300/40"
            >
                <div class="flex items-center gap-3 min-w-0">
                    <p
                        class="text-[11px] font-mono truncate opacity-80 flex-1 min-w-0"
                        [title]="gameInstallDirectorySig() || ''"
                    >
                        {{ gameInstallDirectorySig() || t('common.not_set') }}
                    </p>

                    @if (gameInstallDirectoryValidationSig(); as v) {
                        <div
                            class="badge badge-xs gap-1 border-none px-1.5"
                            [class.bg-success]="v.valid"
                            [class.text-success-content]="v.valid"
                            [class.bg-error]="!v.valid"
                            [class.text-error-content]="!v.valid"
                        >
                            @if (v.valid) {
                                <i-lucide
                                    name="check"
                                    class="h-2.5 w-2.5"
                                ></i-lucide>
                                <span class="text-[10px]">{{
                                    t('settings.validDirectory')
                                }}</span>
                            } @else {
                                <i-lucide
                                    name="x"
                                    class="h-2.5 w-2.5"
                                ></i-lucide>
                                <span class="text-[10px]">{{
                                    t('settings.invalidDirectory')
                                }}</span>
                            }
                        </div>

                        @if (!v.valid && v.errorCode) {
                            <div
                                class="tooltip tooltip-error"
                                [attr.data-tip]="
                                    t('settings.errorResolution.' + v.errorCode)
                                "
                            >
                                <i-lucide
                                    name="alert-circle"
                                    class="h-4 w-4 text-error"
                                ></i-lucide>
                            </div>
                        }
                    }
                </div>

                @if (gameInstallDirectoryValidationSig(); as v) {
                    <p class="mt-2 text-[11px] opacity-70">
                        @if (v.valid) {
                            {{ t(v.message, { count: v.packageCount ?? 0 }) }}
                        } @else {
                            {{ t(v.message) }}
                        }
                    </p>
                }
            </div>

            <div class="divider my-5"></div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title text-sm uppercase opacity-50">
                    {{ t('settings.directoryList') }}
                </h2>
                <button
                    class="btn btn-primary btn-sm"
                    (click)="onAddDirectory()"
                    [disabled]="loadingSig()"
                >
                    @if (loadingSig()) {
                        <span class="loading loading-spinner loading-xs"></span>
                    }
                    <i-lucide name="plus" class="h-4 w-4"></i-lucide>
                    {{ t('settings.addDirectory') }}
                </button>
            </div>

            @if (isAnyValidatingSig()) {
                <div class="mb-4">
                    <div
                        class="flex justify-between text-[10px] mb-1 opacity-70"
                    >
                        <span>{{ t('settings.validatingDirectories') }}</span>
                    </div>
                    <progress
                        class="progress progress-primary w-full h-1"
                        [value]="validationProgressSig()"
                        max="100"
                    ></progress>
                </div>
            }
            @if (directoriesSig().length === 0) {
                <div
                    class="text-center py-10 bg-base-200/50 rounded-lg border-2 border-dashed border-base-300"
                >
                    <i-lucide
                        name="folder-open"
                        class="h-10 w-10 mx-auto opacity-20 mb-2"
                    ></i-lucide>
                    <p class="text-sm opacity-50">
                        {{ t('settings.noDirectories') }}
                    </p>
                </div>
            } @else {
                <div
                    class="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"
                >
                    @for (dir of directoriesSig(); track dir.id) {
                        <div
                            class="directory-item flex items-center justify-between p-3 bg-base-200/50 rounded-lg border border-transparent hover:border-base-300 hover:bg-base-200 transition-all duration-150 ease-in-out hover:-translate-y-[-1px] hover:shadow-lg"
                        >
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p
                                                class="font-medium text-sm truncate"
                                                [title]="dir.path"
                                            >
                                                {{ dir.displayName }}
                                            </p>

                                            <div
                                                class="badge badge-xs gap-1 border-none px-1.5"
                                                [class.bg-success]="
                                                    dir.status === 'valid'
                                                "
                                                [class.text-success-content]="
                                                    dir.status === 'valid'
                                                "
                                                [class.bg-error]="
                                                    dir.status === 'invalid'
                                                "
                                                [class.text-error-content]="
                                                    dir.status === 'invalid'
                                                "
                                                [class.bg-base-300]="
                                                    dir.status === 'pending'
                                                "
                                            >
                                                @if (dir.status === 'valid') {
                                                    <i-lucide
                                                        name="check"
                                                        class="h-2.5 w-2.5"
                                                    ></i-lucide>
                                                    <span class="text-[10px]">{{
                                                        t(
                                                            'settings.validDirectory'
                                                        )
                                                    }}</span>
                                                } @else if (
                                                    dir.status === 'invalid'
                                                ) {
                                                    <i-lucide
                                                        name="x"
                                                        class="h-2.5 w-2.5"
                                                    ></i-lucide>
                                                    <span class="text-[10px]">{{
                                                        t(
                                                            'settings.invalidDirectory'
                                                        )
                                                    }}</span>
                                                } @else {
                                                    <span
                                                        class="loading loading-spinner h-2.5 w-2.5"
                                                    ></span>
                                                }
                                            </div>
                                        </div>
                                        <p
                                            class="text-[11px] opacity-50 truncate font-mono"
                                            [title]="dir.path"
                                        >
                                            {{ dir.path }}
                                        </p>
                                    </div>

                                    @if (
                                        dir.status === 'invalid' &&
                                        dir.lastError
                                    ) {
                                        <div
                                            class="tooltip tooltip-error"
                                            [attr.data-tip]="
                                                dir.lastError.message
                                            "
                                        >
                                            <i-lucide
                                                name="alert-circle"
                                                class="h-4 w-4 text-error"
                                            ></i-lucide>
                                        </div>
                                    }
                                    @if (validatingSig()[dir.id]) {
                                        <span
                                            class="loading loading-spinner loading-xs text-primary"
                                        ></span>
                                    }
                                </div>

                                <div
                                    class="flex gap-4 mt-1.5 text-[10px] opacity-60"
                                >
                                    @if (dir.lastScannedAt > 0) {
                                        <span class="flex items-center gap-1">
                                            <i-lucide
                                                name="refresh-cw"
                                                class="h-2.5 w-2.5"
                                            ></i-lucide>
                                            {{
                                                'settings.lastScanned'
                                                    | transloco
                                                        : {
                                                              date: formatTimestamp(
                                                                  dir.lastScannedAt
                                                              ),
                                                          }
                                            }}
                                        </span>
                                    }
                                    @if (
                                        dir.packageCount !== undefined &&
                                        dir.packageCount !== null
                                    ) {
                                        <span class="flex items-center gap-1">
                                            <i-lucide
                                                name="package"
                                                class="h-2.5 w-2.5"
                                            ></i-lucide>
                                            {{
                                                'settings.packageCount'
                                                    | transloco
                                                        : {
                                                              count: dir.packageCount,
                                                          }
                                            }}
                                        </span>
                                    }
                                </div>

                                @if (
                                    dir.status === 'invalid' && dir.lastError
                                ) {
                                    <div
                                        class="mt-2 text-[11px] text-error bg-error/5 p-2 rounded border border-error/10"
                                    >
                                        <p class="font-bold">
                                            {{ dir.lastError.message }}
                                        </p>
                                        <p class="mt-0.5 opacity-80">
                                            {{
                                                t(
                                                    'settings.errorResolution.' +
                                                        dir.lastError.errorCode
                                                )
                                            }}
                                        </p>
                                    </div>
                                }
                            </div>

                            <div class="flex gap-1 ml-4 items-center">
                                <button
                                    class="btn btn-ghost btn-xs btn-square transition-all duration-150 ease"
                                    (click)="onToggleActive(dir.id)"
                                    [class.text-primary]="dir.active ?? true"
                                    [class.opacity-40]="!(dir.active ?? true)"
                                    title="{{
                                        (dir.active ?? true)
                                            ? t('settings.activeDirectory')
                                            : t('settings.inactiveDirectory')
                                    }}"
                                >
                                    <i-lucide
                                        class="h-4 w-4"
                                        [name]="
                                            (dir.active ?? true)
                                                ? 'toggle-right'
                                                : 'toggle-left'
                                        "
                                    ></i-lucide>
                                </button>

                                <button
                                    class="btn btn-ghost btn-xs btn-square"
                                    (click)="onRevalidateDirectory(dir.id)"
                                    [disabled]="validatingSig()[dir.id]"
                                    title="{{ t('settings.revalidate') }}"
                                >
                                    @if (validatingSig()[dir.id]) {
                                        <span
                                            class="loading loading-spinner h-3.5 w-3.5"
                                        ></span>
                                    } @else {
                                        <i-lucide
                                            name="refresh-ccw"
                                            class="h-3.5 w-3.5"
                                        ></i-lucide>
                                    }
                                </button>

                                <button
                                    class="btn btn-ghost btn-xs btn-square text-error/60 hover:text-error hover:bg-error/10 transition-all duration-150 ease"
                                    (click)="onRemoveDirectory(dir.id)"
                                    title="{{ t('settings.removeDirectory') }}"
                                >
                                    <i-lucide
                                        name="trash-2"
                                        class="h-3.5 w-3.5"
                                    ></i-lucide>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            @if (errorSig()) {
                <div class="alert alert-error mt-4 py-2 px-3 text-sm">
                    <i-lucide
                        name="alert-circle"
                        class="h-4 w-4 shrink-0"
                    ></i-lucide>
                    <span>{{ errorSig() }}</span>
                </div>
            }
        </div>
    </div>
</div>
