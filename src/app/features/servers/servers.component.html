<div class="container mx-auto p-2 sm:p-4" *transloco="let t">
    <!-- Header (Compact) -->
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">{{ t('servers.title') }}</h1>
        <div class="join">
            <!-- Column Toggle Button -->
            <div class="dropdown dropdown-end">
                <button
                    tabindex="0"
                    class="btn btn-sm sm:btn-md join-item"
                    [title]="t('servers.column_toggle')"
                >
                    <i-lucide name="settings-2" class="h-4 w-4"></i-lucide>
                </button>
                <ul
                    tabindex="0"
                    class="dropdown-content menu bg-base-100 rounded-box z-[1] w-56 p-2 shadow-sm border border-base-300"
                >
                    @for (column of columns; track column.key) {
                        @if (!column.alwaysVisible) {
                            <li>
                                <label
                                    class="label cursor-pointer justify-start gap-2"
                                >
                                    <input
                                        type="checkbox"
                                        class="checkbox checkbox-xs"
                                        [checked]="isColumnVisible(column.key)"
                                        (change)="toggleColumn(column.key)"
                                    />
                                    <span class="label-text text-xs">{{
                                        t(column.i18nKey)
                                    }}</span>
                                </label>
                            </li>
                        }
                    }
                </ul>
            </div>
            <!-- Scrolling Mode Toggle Button -->
            <button
                class="btn btn-sm sm:btn-md join-item"
                (click)="toggleScrollingMode()"
                [title]="'scrolling.toggleTooltip' | transloco"
            >
                <i-lucide
                    [name]="
                        isTableOnlyMode() ? 'arrow-down-to-line' : 'maximize-2'
                    "
                    class="h-4 w-4"
                ></i-lucide>
            </button>
            <button
                class="btn btn-sm sm:btn-md join-item"
                (click)="onRefresh()"
                [disabled]="loading()"
            >
                <i-lucide
                    name="refresh-cw"
                    [class.animate-spin]="loading()"
                    class="h-4 w-4"
                ></i-lucide>
                <span class="hidden xs:inline">{{ t('servers.refresh') }}</span>
            </button>
            <button
                class="btn btn-sm sm:btn-md join-item"
                (click)="onPingServers()"
                [disabled]="pinging() || loading()"
            >
                <i-lucide name="activity" class="h-4 w-4"></i-lucide>
                <span class="hidden xs:inline">{{
                    t('servers.ping_all')
                }}</span>
            </button>
        </div>
    </div>

    <!-- Error Alert -->
    @if (error()) {
        <div class="alert alert-warning mb-4 py-2 text-sm">
            <i-lucide name="alert-triangle" class="h-4 w-4"></i-lucide>
            <span>{{ error() }}</span>
        </div>
    }

    <!-- Filters (Compact) -->
    <div class="card bg-base-200 mb-4 shadow-sm">
        <div class="card-body p-3 sm:p-4">
            <h2 class="card-title text-sm uppercase opacity-60">
                {{ t('servers.filters') }}
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Search -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">{{
                            t('servers.search')
                        }}</span>
                    </label>
                    <input
                        type="text"
                        [placeholder]="t('servers.search_placeholder')"
                        class="input input-bordered input-sm"
                        [value]="filter().search || ''"
                        (input)="onSearchChange($event)"
                    />
                </div>

                <!-- Country Filter -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">{{
                            t('servers.country')
                        }}</span>
                    </label>
                    <select
                        class="select select-bordered select-sm"
                        [value]="filter().country || ''"
                        (change)="onCountryChange($event)"
                    >
                        <option value="">
                            {{ t('servers.all_countries') }}
                        </option>
                        @for (country of countries(); track country) {
                            <option [value]="country">{{ country }}</option>
                        }
                    </select>
                </div>

                <!-- Map Filter -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">{{
                            t('servers.map')
                        }}</span>
                    </label>
                    <select
                        class="select select-bordered select-sm"
                        [value]="filter().map || ''"
                        (change)="onMapChange($event)"
                    >
                        <option value="">{{ t('servers.all_maps') }}</option>
                        @for (map of maps(); track map) {
                            <option [value]="map">{{ map }}</option>
                        }
                    </select>
                </div>

                <!-- Favorites Toggle -->
                <div class="form-control flex justify-end">
                    <label
                        class="label cursor-pointer justify-start gap-3 py-1 mt-auto"
                    >
                        <input
                            type="checkbox"
                            class="checkbox checkbox-primary checkbox-sm"
                            [checked]="filter().isFavorite"
                            (change)="onFavoritesToggleChange($event)"
                        />
                        <span class="label-text text-xs">{{
                            t('servers.show_favorites')
                        }}</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
        <div class="flex justify-center items-center h-32">
            <span class="loading loading-spinner loading-md"></span>
        </div>
    }

    <!-- Servers Table (Optimized for 800px) -->
    @if (!loading() && paginatedServers().length > 0) {
        <div
            [class]="
                isTableOnlyMode()
                    ? 'h-[600px] overflow-y-auto'
                    : 'overflow-x-auto'
            "
            class="border border-base-300 rounded-lg"
        >
            <table class="table table-zebra table-xs sm:table-sm min-w-max">
                <thead>
                    <tr>
                        <!-- Left sticky: Favorite -->
                        <th
                            class="w-10 min-w-10 max-w-10 sticky left-0 z-30 bg-base-200"
                        ></th>
                        <!-- Left sticky: Name -->
                        <th
                            (click)="onColumnSort('name')"
                            class="cursor-pointer hover:bg-base-300 sticky left-10 z-30 bg-base-200 border-r border-base-300"
                        >
                            {{ t('servers.column.name') }}
                            @if (sort().field === 'name') {
                                <span class="ml-1 opacity-50">{{
                                    sort().direction === 'asc' ? '↑' : '↓'
                                }}</span>
                            }
                        </th>
                        <!-- Middle columns (scrollable) -->
                        @for (column of columns; track column.key) {
                            @if (
                                column.key !== 'name' &&
                                column.key !== 'action' &&
                                isColumnVisible(column.key)
                            ) {
                                @if (isColumnSortable(column.key)) {
                                    <th
                                        (click)="onColumnSort(column.key)"
                                        class="cursor-pointer hover:bg-base-300 {{
                                            getColumnAlignment(column.alignment)
                                        }}"
                                    >
                                        {{ t(column.i18nKey) }}
                                        @if (sort().field === column.key) {
                                            <span class="ml-1 opacity-50">{{
                                                sort().direction === 'asc'
                                                    ? '↑'
                                                    : '↓'
                                            }}</span>
                                        }
                                    </th>
                                } @else {
                                    <th
                                        class="{{
                                            getColumnAlignment(column.alignment)
                                        }}"
                                    >
                                        {{ t(column.i18nKey) }}
                                    </th>
                                }
                            }
                        }
                        <!-- Right sticky: Action -->
                        <th
                            class="w-20 min-w-20 sticky right-0 z-30 bg-base-200 border-l border-base-300"
                        ></th>
                    </tr>
                </thead>
                <tbody>
                    @for (
                        server of paginatedServers();
                        track server.id;
                        let i = $index
                    ) {
                        <tr>
                            <!-- Left sticky: Favorite -->
                            <td
                                class="sticky left-0 z-20 border-r border-base-300"
                                [class.bg-base-100]="i % 2 === 0"
                                [class.bg-base-200]="i % 2 === 1"
                            >
                                <button
                                    class="btn btn-ghost btn-xs btn-square"
                                    (click)="onToggleFavorite(server)"
                                    [title]="t('servers.favorite')"
                                >
                                    <i-lucide
                                        name="star"
                                        class="h-3.5 w-3.5"
                                        [class.fill-warning]="
                                            isFavorite(server.id)
                                        "
                                        [class.text-warning]="
                                            isFavorite(server.id)
                                        "
                                    >
                                    </i-lucide>
                                </button>
                            </td>
                            <!-- Left sticky: Name -->
                            <td
                                class="font-medium max-w-[120px] sm:max-w-[200px] truncate sticky left-10 z-20 border-r border-base-300"
                                [class.bg-base-100]="i % 2 === 0"
                                [class.bg-base-200]="i % 2 === 1"
                            >
                                <span
                                    [innerHTML]="highlight(server.name)"
                                ></span>
                            </td>
                            <!-- Middle cells (scrollable) -->
                            @for (column of columns; track column.key) {
                                @if (
                                    column.key !== 'name' &&
                                    column.key !== 'action' &&
                                    isColumnVisible(column.key)
                                ) {
                                    <td
                                        class="{{
                                            getColumnAlignment(column.alignment)
                                        }}"
                                    >
                                        @switch (column.key) {
                                            @case ('address') {
                                                <span
                                                    class="font-mono text-[10px] opacity-60"
                                                    [innerHTML]="
                                                        highlight(
                                                            server.address
                                                        )
                                                    "
                                                ></span>
                                            }
                                            @case ('port') {
                                                <span
                                                    class="font-mono text-[10px] opacity-60"
                                                    >{{ server.port }}</span
                                                >
                                            }
                                            @case ('botCount') {
                                                <span
                                                    class="font-mono text-[10px] opacity-60"
                                                    >{{ server.botCount }}</span
                                                >
                                            }
                                            @case ('country') {
                                                <span
                                                    class="text-xs opacity-70"
                                                    [innerHTML]="
                                                        highlight(
                                                            server.country
                                                        )
                                                    "
                                                ></span>
                                            }
                                            @case ('mode') {
                                                @if (server.mode) {
                                                    <span
                                                        class="badge badge-outline bg-blue-50 text-blue-700 border-blue-200 font-medium text-[10px] px-2 py-0.5 rounded-md"
                                                    >
                                                        <span
                                                            [innerHTML]="
                                                                highlight(
                                                                    server.mode
                                                                )
                                                            "
                                                        ></span>
                                                    </span>
                                                } @else {
                                                    <span class="opacity-20"
                                                        >-</span
                                                    >
                                                }
                                            }
                                            @case ('realm') {
                                                <span
                                                    class="text-[10px] opacity-60"
                                                    [innerHTML]="
                                                        highlight(
                                                            server.realm || '-'
                                                        )
                                                    "
                                                ></span>
                                            }
                                            @case ('map') {
                                                <span
                                                    class="text-xs opacity-70 truncate max-w-[160px] inline-block"
                                                    [innerHTML]="
                                                        highlight(server.map)
                                                    "
                                                ></span>
                                            }
                                            @case ('mapId') {
                                                <span
                                                    class="font-mono text-[10px] opacity-60 truncate max-w-[260px] inline-block"
                                                    [title]="server.mapId"
                                                >
                                                    <span
                                                        [innerHTML]="
                                                            highlight(
                                                                server.mapId ||
                                                                    '-'
                                                            )
                                                        "
                                                    ></span>
                                                </span>
                                            }
                                            @case ('playerCount') {
                                                <span
                                                    class="{{
                                                        getCapacityBadgeClass(
                                                            server
                                                        )
                                                    }} font-medium text-xs px-2 py-1 rounded-md shadow-sm"
                                                    [title]="
                                                        getCapacityTitle(server)
                                                    "
                                                >
                                                    {{
                                                        server.currentPlayers
                                                    }}/{{ server.maxPlayers }}
                                                </span>
                                            }
                                            @case ('playerNames') {
                                                @if (
                                                    !server.playerNames.length
                                                ) {
                                                    <span class="opacity-20"
                                                        >-</span
                                                    >
                                                } @else {
                                                    <div
                                                        class="flex flex-wrap gap-1 items-start w-full"
                                                    >
                                                        @for (
                                                            p of server.playerNames;
                                                            track p
                                                        ) {
                                                            <span
                                                                class="badge gap-0 badge-neutral text-xs whitespace-nowrap flex-shrink-0"
                                                            >
                                                                <span
                                                                    [innerHTML]="
                                                                        highlight(
                                                                            p
                                                                        )
                                                                    "
                                                                ></span>
                                                            </span>
                                                        }
                                                    </div>
                                                }
                                            }
                                            @case ('comment') {
                                                <span
                                                    class="text-[10px] opacity-60 whitespace-normal break-words"
                                                    [innerHTML]="
                                                        highlight(
                                                            server.comment ||
                                                                '-'
                                                        )
                                                    "
                                                ></span>
                                            }
                                            @case ('dedicated') {
                                                <span
                                                    class="badge badge-xs"
                                                    [class.badge-success]="
                                                        server.dedicated
                                                    "
                                                    [class.badge-ghost]="
                                                        !server.dedicated
                                                    "
                                                >
                                                    {{
                                                        server.dedicated
                                                            ? 'Yes'
                                                            : 'No'
                                                    }}
                                                </span>
                                            }
                                            @case ('mod') {
                                                <span
                                                    class="badge badge-xs"
                                                    [class.badge-warning]="
                                                        server.mod
                                                    "
                                                    [class.badge-ghost]="
                                                        !server.mod
                                                    "
                                                >
                                                    {{
                                                        server.mod
                                                            ? 'Yes'
                                                            : 'No'
                                                    }}
                                                </span>
                                            }
                                            @case ('steamLink') {
                                                <a
                                                    [href]="server.steamLink"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="link link-primary text-[10px] truncate max-w-[220px] inline-block"
                                                    [title]="server.steamLink"
                                                >
                                                    {{ t('servers.join') }}
                                                </a>
                                            }
                                            @case ('version') {
                                                <span
                                                    class="font-mono text-[10px] opacity-60"
                                                    [innerHTML]="
                                                        highlight(
                                                            server.version ||
                                                                '-'
                                                        )
                                                    "
                                                ></span>
                                            }
                                            @case ('ping') {
                                                @if (
                                                    server.ping !== undefined
                                                ) {
                                                    <span
                                                        class="text-[10px] font-mono"
                                                        [class.text-success]="
                                                            server.ping < 100
                                                        "
                                                        [class.text-warning]="
                                                            server.ping >=
                                                                100 &&
                                                            server.ping < 200
                                                        "
                                                        [class.text-error]="
                                                            server.ping >= 200
                                                        "
                                                    >
                                                        {{ server.ping }}ms
                                                    </span>
                                                } @else {
                                                    <span class="opacity-20"
                                                        >-</span
                                                    >
                                                }
                                            }
                                        }
                                    </td>
                                }
                            }
                            <!-- Right sticky: Action -->
                            <td
                                class="sticky right-0 z-20 border-l border-base-300"
                                [class.bg-base-100]="i % 2 === 0"
                                [class.bg-base-200]="i % 2 === 1"
                            >
                                <a
                                    [href]="server.steamLink"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="btn btn-primary btn-xs px-2"
                                    [title]="t('servers.join')"
                                >
                                    <i-lucide
                                        name="external-link"
                                        class="h-3 w-3"
                                    ></i-lucide>
                                    <span class="hidden xs:inline">{{
                                        t('servers.join')
                                    }}</span>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Footer Stats & Pagination (Compact) -->
        <div
            class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3 px-1"
        >
            <div class="text-[10px] text-base-content/50 order-2 sm:order-1">
                {{
                    t('servers.pagination_info', {
                        start: getDisplayRange().start,
                        end: getDisplayRange().end,
                        total: totalItems(),
                    })
                }}
            </div>

            @if (totalPages() > 1) {
                <div class="join order-1 sm:order-2">
                    @for (page of getPageNumbers(); track page) {
                        @if (page === -1) {
                            <button
                                class="btn btn-xs join-item pointer-events-none opacity-50"
                            >
                                ...
                            </button>
                        } @else {
                            <button
                                class="btn btn-xs join-item"
                                [class.btn-active]="
                                    page === pagination().currentPage
                                "
                                (click)="onPageChange(page)"
                            >
                                {{ page }}
                            </button>
                        }
                    }
                </div>
            }
        </div>
    }

    <!-- Empty State -->
    @if (!loading() && paginatedServers().length === 0) {
        <div class="text-center py-10 opacity-40">
            <i-lucide name="server" class="mx-auto h-12 w-12 mb-2"></i-lucide>
            <h3 class="text-base font-semibold">
                {{ t('servers.no_servers') }}
            </h3>
            <p class="text-xs">{{ t('servers.no_servers_desc') }}</p>
        </div>
    }
</div>
