<div class="flex flex-col sm:flex-row gap-2 mb-4">
    <!-- Search input with class filter -->
    <div class="join flex-1 w-full flex-col gap-2">
        <input
            type="text"
            [placeholder]="'weapons.search' | transloco"
            class="input input-bordered"
            [value]="searchTerm()"
            (input)="onSearch($any($event.target).value)"
        />
        <select
            class="select select-bordered"
            (change)="onTagFilter($any($event.target).value)"
        >
            <option value="">
                {{ 'weapons.filters.allClasses' | transloco }}
            </option>
            @for (tag of availableTags(); track tag) {
                <option [value]="tag" [selected]="selectedTag() === tag">
                    {{ tag }}
                </option>
            }
        </select>
    </div>
    <!-- Page Size Selector -->
    <div class="form-control">
        <label class="label py-1">
            <span class="label-text text-xs">{{
                'weapons.page_size' | transloco
            }}</span>
        </label>
        <select
            class="select select-bordered select-sm"
            [value]="pagination().pageSize"
            (change)="onPageSizeChange($event)"
        >
            @for (size of pageSizeOptions; track size) {
                <option [value]="size">
                    {{ 'weapons.page_size_' + size | transloco }}
                </option>
            }
        </select>
    </div>
    <!-- Column Toggle Dropdown -->
    <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-outline">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"
                />
            </svg>
        </div>
        <ul
            tabindex="0"
            class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-52"
        >
            <li class="menu-title">
                <span>{{ 'weapons.column.selectColumns' | transloco }}</span>
            </li>
            @for (col of columns; track col.key) {
                <li>
                    <label class="label cursor-pointer gap-2 justify-start">
                        <input
                            type="checkbox"
                            class="checkbox checkbox-xs"
                            [checked]="isColumnVisible(col.key)"
                            [disabled]="isColumnDisabled(col.key)"
                            (change)="onColumnToggle(col.key)"
                        />
                        <span class="label-text text-sm">{{
                            col.i18nKey | transloco
                        }}</span>
                    </label>
                </li>
            }
        </ul>
    </div>
    <!-- Scrolling Mode Toggle Button -->
    <button
        class="btn btn-outline"
        (click)="toggleScrollingMode()"
        [title]="'scrolling.toggleTooltip' | transloco"
    >
        <i-lucide
            [name]="isTableOnlyMode() ? 'arrow-down-to-line' : 'maximize-2'"
            class="h-5 w-5"
        ></i-lucide>
    </button>
    <!-- Refresh button -->
    <button class="btn btn-primary" (click)="onRefresh()">
        @if (loading()) {
            <span class="loading loading-spinner"></span>
        }
        {{ 'weapons.refresh' | transloco }}
    </button>
</div>

<!-- Advanced Search Panel -->
<div class="collapse collapse-arrow bg-base-200 mb-4">
    <input
        type="checkbox"
        [checked]="showAdvancedSearch()"
        (change)="toggleAdvancedSearch()"
    />
    <div class="collapse-title text-lg font-medium">
        {{ 'weapons.advancedSearch' | transloco }}
    </div>
    <div class="collapse-content">
        <!-- Range Filters -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
            <!-- Damage Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'weapons.filters.damage' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="advancedFilters().damage?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'damage',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="advancedFilters().damage?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'damage',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>

            <!-- Fire Rate Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'weapons.filters.fireRate' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="advancedFilters().fireRate?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'fireRate',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="advancedFilters().fireRate?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'fireRate',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>

            <!-- Magazine Size Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'weapons.filters.magazineSize' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="advancedFilters().magazineSize?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'magazineSize',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="advancedFilters().magazineSize?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'magazineSize',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>

            <!-- Encumbrance Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'weapons.filters.encumbrance' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="advancedFilters().encumbrance?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'encumbrance',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="advancedFilters().encumbrance?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'encumbrance',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>

            <!-- Price Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'weapons.filters.price' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="advancedFilters().price?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'price',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="advancedFilters().price?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'price',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>
        </div>

        <!-- Exact Match Filters -->
        <div class="flex flex-wrap gap-3 mb-3">
            <label class="label cursor-pointer gap-2">
                <input
                    type="checkbox"
                    class="checkbox checkbox-xs"
                    [checked]="advancedFilters().suppressed === true"
                    (change)="
                        onExactFilter(
                            'suppressed',
                            $any($event.target).checked ? true : undefined
                        )
                    "
                />
                <span class="label-text text-xs">{{
                    'weapons.filters.suppressed' | transloco
                }}</span>
            </label>

            <label class="label cursor-pointer gap-2">
                <input
                    type="checkbox"
                    class="checkbox checkbox-xs"
                    [checked]="advancedFilters().canRespawnWith === true"
                    (change)="
                        onExactFilter(
                            'canRespawnWith',
                            $any($event.target).checked ? true : undefined
                        )
                    "
                />
                <span class="label-text text-xs">{{
                    'weapons.filters.canRespawnWith' | transloco
                }}</span>
            </label>
        </div>

        <!-- Clear Filters Button -->
        <button class="btn btn-ghost btn-sm" (click)="onClearFilters()">
            {{ 'weapons.clearFilters' | transloco }}
        </button>
    </div>
</div>

<!-- Error Alert -->
@if (hasError()) {
    <div class="alert alert-error mb-4">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="stroke-current shrink-0 h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
        </svg>
        <span>{{ error() }}</span>
    </div>
}

<!-- Loading State -->
@if (loading()) {
    <div class="alert alert-info mb-4">
        <span class="loading loading-spinner"></span>
        <span>{{ 'weapons.scanning' | transloco }}</span>
    </div>
}

<!-- Weapons Table -->
<div
    [class]="
        isTableOnlyMode() ? 'h-[600px] overflow-y-auto' : 'overflow-x-auto'
    "
>
    <table class="table table-xs">
        <thead>
            <tr>
                @for (col of getVisibleColumns(); track col.key) {
                    <th
                        [class.text-right]="col.alignment === 'right'"
                        class="cursor-pointer hover:bg-base-200 transition-colors"
                        [title]="
                            'weapons.sort.' +
                                (getColumnSortDirection(col.key) || 'unsorted')
                                | transloco
                        "
                        (click)="onColumnClick(col.key)"
                    >
                        <div
                            class="flex items-center gap-1"
                            [class.justify-end]="col.alignment === 'right'"
                        >
                            <span>{{ col.i18nKey | transloco }}</span>
                            @if (getColumnSortDirection(col.key) === 'asc') {
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-3 w-3"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 15l7-7 7 7"
                                    />
                                </svg>
                            } @else if (
                                getColumnSortDirection(col.key) === 'desc'
                            ) {
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-3 w-3"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"
                                    />
                                </svg>
                            }
                        </div>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @if (weaponCount() === 0) {
                <tr>
                    <td
                        [colSpan]="getVisibleColumns().length"
                        class="text-center"
                    >
                        {{ 'weapons.noWeapons' | transloco }}
                    </td>
                </tr>
            } @else {
                @for (weapon of paginatedWeapons(); track weapon._id) {
                    <tr
                        class="cursor-pointer hover:bg-base-200"
                        [class.active]="selectedWeapon()?.key === weapon.key"
                        (click)="selectWeapon(weapon)"
                        (keydown.arrowDown)="selectNext()"
                        (keydown.arrowUp)="selectPrevious()"
                        (keydown.escape)="closeDetailPanel()"
                    >
                        @for (col of getVisibleColumns(); track col.key) {
                            <td
                                [class.text-right]="col.alignment === 'right'"
                                [class.text-left]="col.alignment === 'left'"
                            >
                                @if (col.key === 'image') {
                                    <!-- T021: Image column with lazy loading and fallback -->
                                    @if (getWeaponIconUrl(weapon)) {
                                        <img
                                            [src]="getWeaponIconUrl(weapon)"
                                            [alt]="weapon.name"
                                            class="w-12 h-12 object-contain"
                                            loading="lazy"
                                            (error)="onWeaponImageError()"
                                        />
                                    } @else {
                                        <div
                                            class="w-12 h-12 bg-base-300 flex items-center justify-center"
                                        >
                                            <lucide-icon
                                                name="image-off"
                                                class="w-6 h-6 opacity-30"
                                            />
                                        </div>
                                    }
                                } @else if (col.field === 'filePath') {
                                    <div class="flex items-center gap-1">
                                        <span
                                            class="text-xs font-mono truncate flex-1"
                                            [title]="weapon.filePath"
                                        >
                                            {{ weapon.filePath }}
                                        </span>
                                        <button
                                            class="btn btn-ghost btn-xs btn-circle"
                                            [title]="
                                                'weapons.actions.openInEditor'
                                                    | transloco
                                            "
                                            (click)="
                                                $event.stopPropagation();
                                                onOpenInEditor(weapon)
                                            "
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            class="btn btn-ghost btn-xs btn-circle"
                                            [title]="
                                                'weapons.actions.copyPath'
                                                    | transloco
                                            "
                                            (click)="
                                                $event.stopPropagation();
                                                onCopyPath(weapon)
                                            "
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                } @else if (
                                    col.field === 'key' || col.field === 'name'
                                ) {
                                    {{ weapon[col.field] }}
                                } @else if (col.field === 'tag') {
                                    {{ weapon.tag }}
                                } @else if (col.field === 'magazineSize') {
                                    {{ weapon.magazineSize }}
                                } @else if (col.field === 'killProbability') {
                                    {{ weapon.killProbability }}
                                } @else if (col.field === 'retriggerTime') {
                                    {{ weapon.retriggerTime }}
                                } @else {
                                    {{ weapon[col.field] }}
                                }
                            </td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>

    <!-- T060: Pagination Controls -->
    @if (weaponCount() > 0) {
        <div
            class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3 px-1"
        >
            <!-- Display Stats -->
            <div class="text-[10px] text-base-content/50 order-2 sm:order-1">
                {{
                    'weapons.pagination_info'
                        | transloco
                            : {
                                  start: getDisplayRange().start,
                                  end: getDisplayRange().end,
                                  total: totalItems(),
                              }
                }}
            </div>

            <!-- Page Navigation -->
            <div class="join order-1 sm:order-2">
                @for (page of getPageNumbers(); track page) {
                    @if (page === -1) {
                        <button
                            class="btn btn-xs join-item pointer-events-none opacity-50"
                        >
                            ...
                        </button>
                    } @else {
                        <button
                            class="btn btn-xs join-item"
                            [class.btn-active]="
                                page === pagination().currentPage
                            "
                            (click)="onPageChange(page)"
                        >
                            {{ page }}
                        </button>
                    }
                }
            </div>
        </div>
    }

    <div class="text-sm text-opacity-50 mt-2">
        {{ 'weapons.weaponCount' | transloco: { count: weaponCount() } }}
    </div>
</div>

<!-- Detail Side Panel -->
@if (isDetailPanelOpen() && selectedWeapon()) {
    <aside @slideIn class="fixed top-0 right-0 w-[75%] min-w-[400px] h-screen bg-base-200 border-l border-base-300 shadow-lg z-50 flex flex-col">
        <!-- Feature 007: Image/Icon Display Section (top of panel, centered, 192px for visual cue) -->
        <div class="flex justify-center py-6 border-b border-base-300">
            @if (getWeaponIconUrl(selectedWeapon()!)) {
                <!-- Display actual game image if available -->
                <img
                    [src]="getWeaponIconUrl(selectedWeapon()!)"
                    [alt]="selectedWeapon()!.name"
                    class="w-48 h-48 object-contain bg-base-300 rounded-lg shadow-md p-4"
                    (error)="onWeaponImageError()"
                />
            } @else {
                <!-- Fallback to Lucide icon if no image available -->
                <lucide-icon
                    [name]="getIconForWeaponType(selectedWeapon()!.tag || '')"
                    class="w-48 h-48 p-8 bg-base-300 rounded-lg text-primary shadow-md"
                    [attr.aria-label]="'Weapon type: ' + selectedWeapon()!.tag">
                </lucide-icon>
            }
        </div>

        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-base-300">
            <h3 class="font-bold text-lg">{{ selectedWeapon()!.name }}</h3>
            <button class="btn btn-sm btn-circle btn-ghost" (click)="closeDetailPanel()">
                <lucide-icon name="X"></lucide-icon>
            </button>
        </div>

            <!-- Content -->
            <div class="flex-1 p-4 overflow-y-auto">
                <!-- Basic Info -->
                <div class="mb-4">
                    <div class="mb-2">
                        <span class="text-xs opacity-70">{{ 'weapons.columns.key' | transloco }}</span>
                        <div class="font-mono text-sm">{{ selectedWeapon()!.key || '-' }}</div>
                    </div>
                    <div class="mb-2">
                        <span class="text-xs opacity-70">{{ 'weapons.columns.class' | transloco }}</span>
                        <div class="text-sm">{{ selectedWeapon()!.tag || '-' }}</div>
                    </div>
                    <div class="mb-2">
                        <span class="text-xs opacity-70">{{ 'weapons.columns.filePath' | transloco }}</span>
                        <div class="text-xs font-mono break-all">{{ selectedWeapon()!.filePath }}</div>
                    </div>
                    <div class="mb-2">
                        <span class="text-xs opacity-70">{{ 'weapons.details.package' | transloco }}</span>
                        <div class="text-sm">{{ selectedWeapon()!.packageName }}</div>
                    </div>
                </div>

            <!-- Specifications -->
            <h4 class="font-semibold text-md mb-2">{{ 'weapons.details.specifications' | transloco }}</h4>
            <table class="table table-sm mb-4">
                <tbody>
                    <tr>
                        <td>{{ 'weapons.columns.magazineSize' | transloco }}</td>
                        <td class="text-right font-mono text-xs">{{ selectedWeapon()!.magazineSize }}</td>
                    </tr>
                    <tr>
                        <td>{{ 'weapons.columns.killProbability' | transloco }}</td>
                        <td class="text-right font-mono text-xs">{{ selectedWeapon()!.killProbability }}</td>
                    </tr>
                    <tr>
                        <td>{{ 'weapons.columns.retriggerTime' | transloco }}</td>
                        <td class="text-right font-mono text-xs">{{ selectedWeapon()!.retriggerTime }}</td>
                    </tr>
                    @if (selectedWeapon()!.projectileSpeed !== null && selectedWeapon()!.projectileSpeed !== undefined) {
                        <tr>
                            <td>{{ 'weapons.details.projectileSpeed' | transloco }}</td>
                            <td class="text-right font-mono text-xs">{{ selectedWeapon()!.projectileSpeed }}</td>
                        </tr>
                    }
                    @if (selectedWeapon()!.encumbrance !== null && selectedWeapon()!.encumbrance !== undefined) {
                        <tr>
                            <td>{{ 'weapons.filters.encumbrance' | transloco }}</td>
                            <td class="text-right font-mono text-xs">{{ selectedWeapon()!.encumbrance }}</td>
                        </tr>
                    }
                    @if (selectedWeapon()!.price !== null && selectedWeapon()!.price !== undefined) {
                        <tr>
                            <td>{{ 'weapons.filters.price' | transloco }}</td>
                            <td class="text-right font-mono text-xs">{{ selectedWeapon()!.price }}</td>
                        </tr>
                    }
                    <tr>
                        <td>{{ 'weapons.details.suppressed' | transloco }}</td>
                        <td class="text-right">
                            @if (selectedWeapon()!.suppressed) {
                                <span class="badge badge-success">{{ 'weapons.details.yes' | transloco }}</span>
                            } @else {
                                <span class="badge badge-ghost">{{ 'weapons.details.no' | transloco }}</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td>{{ 'weapons.details.canRespawnWith' | transloco }}</td>
                        <td class="text-right">
                            @if (selectedWeapon()!.canRespawnWith) {
                                <span class="badge badge-success">{{ 'weapons.details.yes' | transloco }}</span>
                            } @else {
                                <span class="badge badge-ghost">{{ 'weapons.details.no' | transloco }}</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td>{{ 'weapons.details.inStock' | transloco }}</td>
                        <td class="text-right">
                            @if (selectedWeapon()!.inStock) {
                                <span class="badge badge-success">{{ 'weapons.details.yes' | transloco }}</span>
                            } @else {
                                <span class="badge badge-ghost">{{ 'weapons.details.no' | transloco }}</span>
                            }
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Stance Accuracies -->
            @if (selectedWeapon()!.stanceAccuracies.length > 0) {
                <h4 class="font-semibold text-md mb-2">{{ 'weapons.details.stanceAccuracies' | transloco }}</h4>
                <table class="table table-sm mb-4">
                    <thead>
                        <tr>
                            <th>{{ 'weapons.details.stance' | transloco }}</th>
                            <th class="text-right">{{ 'weapons.details.accuracy' | transloco }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (stance of selectedWeapon()!.stanceAccuracies; track stance.stance) {
                            <tr>
                                <td>{{ 'weapons.details.stances.' + stance.stance | transloco }}</td>
                                <td class="text-right font-mono text-xs">{{ stance.accuracy }}</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <!-- Chain Variants -->
            @if (selectedWeapon()!.chainVariants.length > 0) {
                <h4 class="font-semibold text-md mb-2">{{ 'weapons.details.chainVariants' | transloco }}</h4>
                <div class="flex flex-wrap gap-2 mb-4">
                    @for (variant of selectedWeapon()!.chainVariants; track variant) {
                        <span class="badge badge-outline">{{ variant }}</span>
                    }
                </div>
            }
        </div>
    </aside>
}
