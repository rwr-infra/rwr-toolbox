<div class="flex flex-col sm:flex-row gap-2 mb-4">
    <!-- Search input with type filter -->
    <div class="join flex-1 w-full flex-col gap-2">
        <input
            type="text"
            [placeholder]="'items.search' | transloco"
            class="input input-bordered"
            [value]="searchTerm()"
            (input)="onSearch($any($event.target).value)"
        />
        <select
            class="select select-bordered"
            (change)="onItemTypeFilter($any($event.target).value)"
        >
            <option value="">
                {{ 'items.filters.allTypes' | transloco }}
            </option>
            @for (type of availableItemTypes(); track type) {
                <option [value]="type" [selected]="selectedItemType() === type">
                    {{ 'items.filters.' + type | transloco }}
                </option>
            }
        </select>
    </div>
    <!-- Page Size Selector -->
    <div class="form-control">
        <label class="label py-1">
            <span class="label-text text-xs">{{
                'items.page_size' | transloco
            }}</span>
        </label>
        <select
            class="select select-bordered select-sm"
            [value]="pagination().pageSize"
            (change)="onPageSizeChange($event)"
        >
            @for (size of pageSizeOptions; track size) {
                <option [value]="size">
                    {{ 'items.page_size_' + size | transloco }}
                </option>
            }
        </select>
    </div>
    <!-- Column Toggle Dropdown -->
    <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-outline">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"
                />
            </svg>
        </div>
        <ul
            tabindex="0"
            class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-52"
        >
            <li class="menu-title">
                <span>{{ 'items.column.selectColumns' | transloco }}</span>
            </li>
            @for (col of columns; track col.key) {
                <li>
                    <label class="label cursor-pointer gap-2 justify-start">
                        <input
                            type="checkbox"
                            class="checkbox checkbox-xs"
                            [checked]="isColumnVisible(col.key)"
                            [disabled]="isColumnDisabled(col.key)"
                            (change)="onColumnToggle(col.key)"
                        />
                        <span class="label-text text-sm">{{
                            col.i18nKey | transloco
                        }}</span>
                    </label>
                </li>
            }
        </ul>
    </div>
    <!-- Scrolling Mode Toggle Button -->
    <button
        class="btn btn-outline"
        (click)="toggleScrollingMode()"
        [title]="'scrolling.toggleTooltip' | transloco"
    >
        <i-lucide
            [name]="isTableOnlyMode() ? 'arrow-down-to-line' : 'maximize-2'"
            class="h-5 w-5"
        ></i-lucide>
    </button>
    <!-- Refresh button -->
    <button class="btn btn-primary" (click)="onRefresh()">
        @if (loading()) {
            <span class="loading loading-spinner"></span>
        }
        {{ 'items.refresh' | transloco }}
    </button>
</div>

<!-- Advanced Search Panel -->
<div class="collapse collapse-arrow bg-base-200 mb-4">
    <input
        type="checkbox"
        [checked]="showAdvancedSearch()"
        (change)="toggleAdvancedSearch()"
    />
    <div class="collapse-title text-lg font-medium">
        {{ 'items.advancedSearch' | transloco }}
    </div>
    <div class="collapse-content">
        <!-- Range Filters -->
        <div class="grid grid-cols-2 gap-2 mb-3">
            <!-- Encumbrance Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'items.columns.encumbrance' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="filters().encumbrance?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'encumbrance',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="filters().encumbrance?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'encumbrance',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>

            <!-- Price Range -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs">{{
                        'items.columns.price' | transloco
                    }}</span>
                </label>
                <div class="join">
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Min"
                        [value]="filters().price?.min ?? ''"
                        (input)="
                            onRangeFilter(
                                'price',
                                'min',
                                $any($event.target).value
                            )
                        "
                    />
                    <input
                        type="number"
                        class="input input-bordered input-xs join-item w-full"
                        placeholder="Max"
                        [value]="filters().price?.max ?? ''"
                        (input)="
                            onRangeFilter(
                                'price',
                                'max',
                                $any($event.target).value
                            )
                        "
                    />
                </div>
            </div>
        </div>

        <!-- Exact Match Filters -->
        <div class="flex flex-wrap gap-3 mb-3">
            <label class="label cursor-pointer gap-2">
                <input
                    type="checkbox"
                    class="checkbox checkbox-xs"
                    [checked]="filters().canRespawnWith === true"
                    (change)="
                        onExactFilter(
                            'canRespawnWith',
                            $any($event.target).checked ? true : undefined
                        )
                    "
                />
                <span class="label-text text-xs">{{
                    'weapons.filters.canRespawnWith' | transloco
                }}</span>
            </label>

            <label class="label cursor-pointer gap-2">
                <input
                    type="checkbox"
                    class="checkbox checkbox-xs"
                    [checked]="filters().inStock === true"
                    (change)="
                        onExactFilter(
                            'inStock',
                            $any($event.target).checked ? true : undefined
                        )
                    "
                />
                <span class="label-text text-xs">{{
                    'weapons.details.inStock' | transloco
                }}</span>
            </label>
        </div>

        <!-- Clear Filters Button -->
        <button class="btn btn-ghost btn-sm" (click)="onClearFilters()">
            {{ 'items.clearFilters' | transloco }}
        </button>
    </div>
</div>

<!-- Error Alert -->
@if (hasError()) {
    <div class="alert alert-error mb-4">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="stroke-current shrink-0 h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
        </svg>
        <span>{{ error() }}</span>
    </div>
}

<!-- Loading State -->
@if (loading()) {
    <div class="alert alert-info mb-4">
        <span class="loading loading-spinner"></span>
        <span>{{ 'items.scanning' | transloco }}</span>
    </div>
}

<!-- Items Table -->
<div
    [class]="
        isTableOnlyMode() ? 'h-[600px] overflow-y-auto' : 'overflow-x-auto'
    "
>
    <table class="table table-xs">
        <thead>
            <tr>
                @for (col of getVisibleColumns(); track col.key) {
                    <th
                        [class.text-right]="col.alignment === 'right'"
                        class="cursor-pointer hover:bg-base-200 transition-colors"
                        [title]="
                            'items.sort.' +
                                (getColumnSortDirection(col.key) || 'unsorted')
                                | transloco
                        "
                        (click)="onColumnClick(col.key)"
                    >
                        <div
                            class="flex items-center gap-1"
                            [class.justify-end]="col.alignment === 'right'"
                        >
                            <span>{{ col.i18nKey | transloco }}</span>
                            @if (getColumnSortDirection(col.key) === 'asc') {
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-3 w-3"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 15l7-7 7 7"
                                    />
                                </svg>
                            } @else if (
                                getColumnSortDirection(col.key) === 'desc'
                            ) {
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-3 w-3"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"
                                    />
                                </svg>
                            }
                        </div>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @if (itemCount() === 0) {
                <tr>
                    <td
                        [colSpan]="getVisibleColumns().length"
                        class="text-center"
                    >
                        {{ 'items.noItems' | transloco }}
                    </td>
                </tr>
            } @else {
                @for (item of paginatedItems(); track item.key ?? item.name) {
                    <tr
                        class="cursor-pointer hover:bg-base-200"
                        (click)="onRowClick(item)"
                    >
                        @for (col of getVisibleColumns(); track col.key) {
                            <td
                                [class.text-right]="col.alignment === 'right'"
                                [class.text-left]="col.alignment === 'left'"
                            >
                                @if (col.key === 'image') {
                                    <!-- T023: Image column with lazy loading and fallback -->
                                    <div
                                        class="flex items-center justify-center"
                                    >
                                        <img
                                            [src]="
                                                'media/items/' +
                                                (item.key || 'unknown') +
                                                '.png'
                                            "
                                            [alt]="item.name"
                                            class="w-8 h-8 object-contain"
                                            loading="lazy"
                                            [style.opacity]="'1'"
                                            (error)="
                                                $event.target.style.display =
                                                    'none'
                                            "
                                        />
                                        @if (!item.key) {
                                            <span class="text-xs opacity-30"
                                                >?</span
                                            >
                                        }
                                    </div>
                                } @else if (col.field === 'filePath') {
                                    <div class="flex items-center gap-1">
                                        <span
                                            class="text-xs font-mono truncate flex-1"
                                            [title]="item.filePath"
                                        >
                                            {{ item.filePath }}
                                        </span>
                                        <button
                                            class="btn btn-ghost btn-xs btn-circle"
                                            [title]="
                                                'items.actions.openInEditor'
                                                    | transloco
                                            "
                                            (click)="
                                                $event.stopPropagation();
                                                onOpenInEditor(item)
                                            "
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            class="btn btn-ghost btn-xs btn-circle"
                                            [title]="
                                                'items.actions.copyPath'
                                                    | transloco
                                            "
                                            (click)="
                                                $event.stopPropagation();
                                                onCopyPath(item)
                                            "
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                } @else {
                                    {{ getColumnValue(item, col.key) }}
                                }
                            </td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>

    <!-- T075: Pagination controls -->
    @if (itemCount() > 0) {
        <div
            class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3 px-1"
        >
            <!-- Display Stats -->
            <div class="text-[10px] text-base-content/50 order-2 sm:order-1">
                {{
                    'items.pagination_info'
                        | transloco
                            : {
                                  start: getDisplayRange().start,
                                  end: getDisplayRange().end,
                                  total: totalItems(),
                              }
                }}
            </div>

            <!-- Page Navigation -->
            <div class="join order-1 sm:order-2">
                @for (page of getPageNumbers(); track page) {
                    @if (page === -1) {
                        <button
                            class="btn btn-xs join-item pointer-events-none opacity-50"
                        >
                            ...
                        </button>
                    } @else {
                        <button
                            class="btn btn-xs join-item"
                            [class.btn-active]="
                                page === pagination().currentPage
                            "
                            (click)="onPageChange(page)"
                        >
                            {{ page }}
                        </button>
                    }
                }
            </div>
        </div>
    }
</div>

<!-- Item Details Modal -->
@if (showItemDetails() && selectedItem()) {
    <dialog class="modal modal-open" [open]="showItemDetails()">
        <div class="modal-box max-w-4xl max-h-[80vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">{{ selectedItem()!.name }}</h3>
                <button
                    class="btn btn-sm btn-circle btn-ghost"
                    (click)="closeItemDetails()"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        />
                    </svg>
                </button>
            </div>

            <!-- Basic Info -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <span class="text-xs opacity-70">{{
                        'items.columns.key' | transloco
                    }}</span>
                    <div class="font-mono text-sm">
                        {{ selectedItem()!.key || '-' }}
                    </div>
                </div>
                <div>
                    <span class="text-xs opacity-70">{{
                        'items.columns.itemType' | transloco
                    }}</span>
                    <div class="text-sm">
                        {{
                            'items.filters.' + selectedItem()!.itemType
                                | transloco
                        }}
                    </div>
                </div>
                @if (getItemSlotValue()) {
                    <div>
                        <span class="text-xs opacity-70">{{
                            'items.columns.slot' | transloco
                        }}</span>
                        <div class="text-sm">
                            {{ getItemSlotValue() }}
                        </div>
                    </div>
                }
                <div>
                    <span class="text-xs opacity-70">{{
                        'items.columns.filePath' | transloco
                    }}</span>
                    <div class="text-xs font-mono">
                        {{ selectedItem()!.filePath }}
                    </div>
                </div>
                <div>
                    <span class="text-xs opacity-70">{{
                        'weapons.details.package' | transloco
                    }}</span>
                    <div class="text-sm">
                        {{ selectedItem()!.packageName }}
                    </div>
                </div>
            </div>

            <!-- Specifications -->
            <h4 class="font-semibold text-md mb-2">
                {{ 'weapons.details.specifications' | transloco }}
            </h4>
            <div class="overflow-x-auto mb-4">
                <table class="table table-xs">
                    <tbody>
                        @if (
                            selectedItem()!.encumbrance !== null &&
                            selectedItem()!.encumbrance !== undefined
                        ) {
                            <tr>
                                <td class="w-1/2">
                                    {{
                                        'items.columns.encumbrance' | transloco
                                    }}
                                </td>
                                <td class="w-1/2 text-right">
                                    {{ selectedItem()!.encumbrance }}
                                </td>
                            </tr>
                        }
                        @if (
                            selectedItem()!.price !== null &&
                            selectedItem()!.price !== undefined
                        ) {
                            <tr>
                                <td>
                                    {{ 'items.columns.price' | transloco }}
                                </td>
                                <td class="text-right">
                                    {{ selectedItem()!.price }}
                                </td>
                            </tr>
                        }
                        @if (
                            selectedItem()!.canRespawnWith !== null &&
                            selectedItem()!.canRespawnWith !== undefined
                        ) {
                            <tr>
                                <td>
                                    {{
                                        'weapons.details.canRespawnWith'
                                            | transloco
                                    }}
                                </td>
                                <td class="text-right">
                                    @if (selectedItem()!.canRespawnWith) {
                                        <span class="badge badge-success">{{
                                            'weapons.details.yes' | transloco
                                        }}</span>
                                    } @else {
                                        <span class="badge badge-ghost">{{
                                            'weapons.details.no' | transloco
                                        }}</span>
                                    }
                                </td>
                            </tr>
                        }
                        @if (
                            selectedItem()!.inStock !== null &&
                            selectedItem()!.inStock !== undefined
                        ) {
                            <tr>
                                <td>
                                    {{ 'weapons.details.inStock' | transloco }}
                                </td>
                                <td class="text-right">
                                    @if (selectedItem()!.inStock) {
                                        <span class="badge badge-success">{{
                                            'weapons.details.yes' | transloco
                                        }}</span>
                                    } @else {
                                        <span class="badge badge-ghost">{{
                                            'weapons.details.no' | transloco
                                        }}</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Footer Actions -->
            <div class="modal-action">
                <button class="btn btn-primary" (click)="closeItemDetails()">
                    {{ 'weapons.details.close' | transloco }}
                </button>
            </div>
        </div>
        <!-- Click outside to close -->
        <form method="dialog">
            <button
                class="modal-backdrop"
                (click)="closeItemDetails()"
            ></button>
        </form>
    </dialog>
}
